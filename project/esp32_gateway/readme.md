[TOC]

### 版本

| 版本号 | 变更内容 | 作者 | 时间       |
| ------ | -------- | ---- | ---------- |
| 1.0.0  | 初始版本 | HB   | 2020.11.06 |



------



### 概述

- esp32 通用网关用于扫描网关附近的 BLE 蓝牙设备，将其**广播包数据** 和 **rssi**  值上传到 云端服务器。



### 计划

| 内容                                                         | 时间  |
| :----------------------------------------------------------- | :---: |
| 1.掌握 esp32 的编译系统，能够新建项目                        | 0.5天 |
| 2.掌握主机例程，扫描广播包数据                               |  1天  |
| 3.掌握 从机例程，建立透传服务                                |  1天  |
| 4.实现主从一体                                               |  1天  |
| 5.掌握 wifi 的例程，能连接上热点                             |  1天  |
| 6.掌握 HTTP 、MQTT 的例程，能通过网络协议上传数据到云端。    |  1天  |
| 7.了解 **flash**布局，掌握 flash 操作相关API ，能保存 配置数据。 |  1天  |
| 8.掌握 **OTA** ，能实现空中升级。                            |  1天  |
| 9.制定网关与云端和手机的通讯协议                             |  3天  |



### APP 端协议

> 适用于安卓和苹果端的通信

#### 广播名称

- ####  **XT_gateway**

- 网关的 mac 地址在扫描回应包的 **service data **中放置一份

#### 加密方式

- 建立连接后，手机必须在 30 秒内发送密码信息给网关，密码验证错误或者超时，网关自动断开连接。
- 默认密码为字符串 **“ 123456”**

##### 密码包格式

| 包头   | 密码   |
| :----- | :----- |
| 5-byte | 6-byte |

#### 配置参数上报

> 密码验证通过后，网关立即将配置参数上报给APP端

##### 上报格式

- 上传配置参数时，每一包最大 20 字节。
- 格式为：包头 (5-btye)+ 内容 ，内容的长度由包头决定。

| 包头类型               | 内容长度      |
| ---------------------- | ------------- |
| 上报周期               | 4-bytes       |
| 广播名称过滤           | 10-bytes      |
| RSSI过滤               | 1-byte        |
| 联网方式（WiFi、网口） | 1-byte        |
| 网络协议（HTTP、MQTT） | 1-byte        |
| 路由器IP和子网掩码     | 8-bytes       |
| 远程ip信息             | 6-bytes       |
| http路径信息           | 小于160-bytes |
| WiFi名称               | 小于30-bytes  |
| WiFi 密码              | 小于30-bytes  |
| mqtt的client id        | 小于15-bytes  |
| mqtt的 topic           | 小于15-bytes  |
| 固件版本               | 4-bytes       |



### 云端协议

> 网关扫描的数据，将通过 HTTP 或 MQTT 协议上报。

#### JSON 包格式

```c
beacons=[
  {
   "devicename":"xBeacon",
   "type":"ibeacon",
   "devicemac":"D1010800012E",
   "gatewaymac":"D11215000109",
   "rssi":-64,
   "data1":"0201061AFF4C000215FDA50693A4E24FB1AFCFC6EB0764782527723D07BB",
   "data2":"080978426561636F6E14162915500B11012C0131D1010800012E27723D07"
   }
]

[
{"devicename":"",
"type":"rsp",
"dMac":"CF0821000003",
"gMac":"D11215000109",
"rssi":"-88",
"data1":"",
"data2":""
},
{"devicename":"",
",data1":"0201061AFF4C000215FDA50693A4E24FB1AFCFC6EB0764782527723CDCBB",
"data2":""
},

{"devicename":"",
"type":"ibeacon",
"dMac":"D2110600055E","gMac":"D11215000109","rssi":"-90",
"data1":"0201061AFF4C000215A000FAA00047005A00526D6F62696B65C6430F67BB",
"data2":""
},
{"devicename":"","type":"ibeacon",
"dMac":"D2110600055A",
"gMac":"D11215000109",
"rssi":"-81",
"data1":"0201061AFF4C000215A000FAA00047005A00526D6F62696B65C6430F63BB",
 "data2":""
},
{"devicename":"",
"type":"ibeacon",
"dMac":"D2082400022B",
"gMac":"D11215000109",
"rssi":"-85",
"data1":"0201061AFF4C000215A000FAA00047005A00526D6F62696B65C6430A03BB",
"data2":""
}
]

```



